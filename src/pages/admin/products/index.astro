---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getAllProducts, deleteProduct } from '../../../lib/products';

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const productId = formData.get('productId');
  
  try {
    await deleteProduct(productId);
    // Redirect to the same page to refresh the product list
    return Astro.redirect('/admin/products');
  } catch (error) {
    console.error('Failed to delete product:', error);
  }
}

if (Astro.request.method === "GET") {
  console.log(Astro.params.id)
}

const products = await getAllProducts();
---

<AdminLayout title="Manage Products">
  <div class="container">
    <h1 class="title">Manage Products</h1>
    <a href="/admin/products/new" class="button is-primary mb-4">Add New Product</a>
    <table class="table is-fullwidth">
      <thead>
        <tr>
          <th>Name</th>
          <th>Category</th>
          <th>Price</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {products.map((product) => (
          <tr>
            <td>{product.name}</td>
            <td>{product.category}</td>
            <td>${product.price.toFixed(2)}</td>
            <td>
              <a href={`/admin/products/edit/${product.id}`} class="button is-small is-info">Edit</a>
              <form method="POST" style="display: inline;">
                
                <input type="hidden" name="productId" value={product.id}>
                <button type="submit" class="button is-small is-danger" onclick="return confirm('Are you sure you want to delete this product?')">Delete</button>
              </form>
            </td>
          </tr>
        ))}
      </tbody>
    </table>
  </div>
</AdminLayout>

